<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù„ÛŒÙ†Ú©â€ŒØ³Ø§Ø² Ù¾ÙˆÛŒØ´ Ù¾Ø±Ú†Ù… Ø¨Ø§Ù„Ø§ (Imgix)</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 30px; background-color: #f5f5f5; }
    h2 { color: #1a73e8; }
    p.warning { background-color: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; border: 1px solid #ffeeba; }
    input[type="file"], select { padding: 10px 14px; font-size: 16px; margin: 12px 0; border-radius: 6px; border: 1px solid #ccc; width: 80%; max-width: 400px; }
    .btn { background-color: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-size: 16px; cursor: pointer; margin: 15px 0; text-decoration: none; display: inline-block; }
    .btn:disabled { background-color: #cccccc; cursor: not-allowed; }
    #output { margin-top: 25px; }
    #output input { direction: ltr; font-family: monospace; width: 90%; max-width: 600px; padding: 10px; font-size: 14px; border: 1px solid #ccc; border-radius: 6px; }
    #preview-img { margin-top: 10px; max-width: 200px; border-radius: 8px; border: 2px solid #ccc; display: none; }
    .loader { border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; display: none; margin: 20px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>


  <h2>ğŸ‡®ğŸ‡· Ù„ÛŒÙ†Ú©â€ŒØ³Ø§Ø² Ù¾ÙˆÛŒØ´ Ù¾Ø±Ú†Ù… Ø¨Ø§Ù„Ø§</h2>
  <p>Ø§Ø¨ØªØ¯Ø§ ØªØµÙˆÛŒØ± Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ Ùˆ Ø³Ù¾Ø³ Ù‚Ø§Ø¨ Ø¯Ù„Ø®ÙˆØ§Ù‡ Ø±Ø§ Ø¨Ø±Ú¯Ø²ÛŒÙ†ÛŒØ¯:</p>
  <p class="warning">âš ï¸ ØªÙˆØ¬Ù‡: Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø®Øª Ù„ÛŒÙ†Ú©ØŒ ØªØµÙˆÛŒØ± Ø´Ù…Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ù…ÙˆÙ‚Øª Ø¯Ø± ÛŒÚ© Ø³Ø±ÙˆÛŒØ³ Ø¢Ù¾Ù„ÙˆØ¯Ø³Ù†ØªØ± Ø¢Ù¾Ù„ÙˆØ¯ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</p>

  <input type="file" id="image-upload" accept="image/*"><br>
  <img id="preview-img" alt="Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ ØªØµÙˆÛŒØ± Ø´Ù…Ø§"><br>

  <select id="frame-select">
    <option value="frame1">ğŸ–¼ Ù‚Ø§Ø¨ Ø´Ù…Ø§Ø±Ù‡ Û±</option>
    <option value="frame2">ğŸ–¼ Ù‚Ø§Ø¨ Ø´Ù…Ø§Ø±Ù‡ Û²</option>
    <option value="frame3">ğŸ–¼ Ù‚Ø§Ø¨ Ø´Ù…Ø§Ø±Ù‡ Û³</option>
  </select><br>

  <button class="btn" id="generate-btn" onclick="processRequest()" disabled>ğŸ”— Ø³Ø§Ø®Øª Ù„ÛŒÙ†Ú© ØªØµÙˆÛŒØ± Ù†Ù‡Ø§ÛŒÛŒ</button>

  <div id="output">
    <div class="loader" id="loader"></div>
    <div id="result-container"></div>
  </div>

  <script>
    // --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ØµÙ„ÛŒ ---
    const IMGBB_API_KEY = "YOUR_API_KEY_HERE"; // <--- Ú©Ù„ÛŒØ¯ API Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯
    const IMGIX_DOMAIN = "bale-bot.imgix.net";
    const FRAME_IMAGE_URLS = {
      frame1: "https://i.postimg.cc/C1BBK6h4/Parcham-Frame-1.png",
      frame2: "https://i.postimg.cc/SKsK0zCn/Parcham-Frame-2.png",
      frame3: "https://i.postimg.cc/bN4wwSGb/Parcham-Frame-3.png"
    };
    // -------------------

    let userImageFile = null;
    const uploadInput = document.getElementById('image-upload');
    const generateBtn = document.getElementById('generate-btn');
    const loader = document.getElementById('loader');
    const resultContainer = document.getElementById('result-container');

    uploadInput.addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (!file) {
        userImageFile = null;
        generateBtn.disabled = true;
        document.getElementById('preview-img').style.display = 'none';
        return;
      }
      userImageFile = file;
      document.getElementById('preview-img').src = URL.createObjectURL(file);
      document.getElementById('preview-img').style.display = 'inline-block';
      generateBtn.disabled = false;
    });

    /**
     * Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ØŒ Ù†Ø³Ø®Ù‡ Ù…Ø±ÙˆØ±Ú¯Ø± Ùˆ Ù‚Ø§Ø¨Ù„ Ø§Ø¬Ø±Ø§ÛŒ Ù…Ù†Ø·Ù‚ÛŒ Ø§Ø³Øª Ú©Ù‡ Ø´Ù…Ø§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ø³ØªÛŒØ¯.
     * @param {string} userImageUrl - Ù„ÛŒÙ†Ú© Ø¹Ù…ÙˆÙ…ÛŒ ØªØµÙˆÛŒØ± Ø¢Ù¾Ù„ÙˆØ¯ Ø´Ø¯Ù‡ Ú©Ø§Ø±Ø¨Ø±
     * @param {string} frameKey - Ú©Ù„ÛŒØ¯ Ù‚Ø§Ø¨ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
     */
    function createFinalImageUrlWithImgix(userImageUrl, frameKey) {
      const frameUrl = FRAME_IMAGE_URLS[frameKey];
      
      // Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ Ø¨Ø±Ø§ÛŒ ØªØµÙˆÛŒØ± Ú©Ø§Ø±Ø¨Ø±
      const baseImageParams = new URLSearchParams({
        'w': '512', 'h': '512', 'fit': 'crop', 'crop': 'faces,entropy'
      });

      // Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ Ù‚Ø§Ø¨ Ú©Ù‡ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† ÙˆØ§ØªØ±Ù…Ø§Ø±Ú© Ø§Ø¹Ù…Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯
      const encodedFrameUrl = btoa(frameUrl).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
      const overlayParams = new URLSearchParams({
        'mark64': encodedFrameUrl, 'mark-w': '512', 'mark-h': '512', 'mark-fit': 'crop'
      });

      // ØªØ±Ú©ÛŒØ¨ Ù‡Ù…Ù‡ Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§
      const finalParams = `${baseImageParams.toString()}&${overlayParams.toString()}`;
      
      // Ø³Ø§Ø®Øª Ù„ÛŒÙ†Ú© Ù†Ù‡Ø§ÛŒÛŒ. Imgix ØªØµÙˆÛŒØ± Ø±Ø§ Ø§Ø² Ù„ÛŒÙ†Ú© Ø¹Ù…ÙˆÙ…ÛŒ Ú©Ø§Ø±Ø¨Ø± Ù…ÛŒâ€ŒØ®ÙˆØ§Ù†Ø¯.
      // Ù…Ø§ ÙØ±Ø¶ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ø³ÙˆØ±Ø³ bale-bot.imgix.net Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù¾Ø±Ø§Ú©Ø³ÛŒ ÙˆØ¨ ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡ Ø§Ø³Øª.
      return `https://${IMGIX_DOMAIN}/${userImageUrl}?${finalParams}`;
    }

    async function processRequest() {
      if (!userImageFile) {
        alert("Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ØªØµÙˆÛŒØ±ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ù…Ø§ÛŒÛŒØ¯.");
        return;
      }
      if (IMGBB_API_KEY === "YOUR_API_KEY_HERE") {
          alert("Ø®Ø·Ø§ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª: Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ú©Ù„ÛŒØ¯ API Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø² Ø³Ø§ÛŒØª imgbb.com Ø¯Ø±ÛŒØ§ÙØª Ú©Ø±Ø¯Ù‡ Ùˆ Ø¯Ø± Ú©Ø¯ Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯.");
          return;
      }

      loader.style.display = 'block';
      generateBtn.disabled = true;
      resultContainer.innerHTML = '';

      // Ù…Ø±Ø­Ù„Ù‡ Û±: Ø¢Ù¾Ù„ÙˆØ¯ ØªØµÙˆÛŒØ± Ú©Ø§Ø±Ø¨Ø± Ø¨Ù‡ imgbb Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª ÛŒÚ© Ù„ÛŒÙ†Ú© Ø¹Ù…ÙˆÙ…ÛŒ
      const formData = new FormData();
      formData.append('image', userImageFile);
      
      try {
        const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
          method: 'POST',
          body: formData,
        });
        const result = await response.json();

        if (!result.success) {
          throw new Error(result.error.message || "Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯ ØªØµÙˆÛŒØ±.");
        }

        const uploadedUserImageUrl = result.data.url;

        // Ù…Ø±Ø­Ù„Ù‡ Û²: Ø³Ø§Ø®Øª Ù„ÛŒÙ†Ú© Ù†Ù‡Ø§ÛŒÛŒ Imgix Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªØ§Ø¨Ø¹ÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ø³ØªÛŒØ¯
        const frameKey = document.getElementById("frame-select").value;
        const finalUrl = createFinalImageUrlWithImgix(uploadedUserImageUrl, frameKey);

        // Ù…Ø±Ø­Ù„Ù‡ Û³: Ù†Ù…Ø§ÛŒØ´ Ù†ØªÛŒØ¬Ù‡ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±
        resultContainer.innerHTML = `
          <p>âœ… Ù„ÛŒÙ†Ú© ØªØµÙˆÛŒØ± Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯:</p>
          <input type="text" value="${finalUrl}" readonly onclick="this.select()">
          <br><br>
          <a href="${finalUrl}" target="_blank" class="btn">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ùˆ Ø°Ø®ÛŒØ±Ù‡ ØªØµÙˆÛŒØ±</a>
        `;

      } catch (error) {
        console.error("Ø®Ø·Ø§:", error);
        alert(`Ù…ØªØ§Ø³ÙØ§Ù†Ù‡ Ù…Ø´Ú©Ù„ÛŒ Ù¾ÛŒØ´ Ø¢Ù…Ø¯: ${error.message}`);
        resultContainer.innerHTML = `<p style="color:red;">Ø³Ø§Ø®Øª Ù„ÛŒÙ†Ú© Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø®ÙˆØ¯ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.</p>`;
      } finally {
        loader.style.display = 'none';
        generateBtn.disabled = false;
      }
    }
  </script>

</body>
</html>
