<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لینک‌ساز پویش پرچم بالا (Imgix)</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 30px; background-color: #f5f5f5; }
    h2 { color: #1a73e8; }
    p.warning { background-color: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; border: 1px solid #ffeeba; }
    input[type="file"], select { padding: 10px 14px; font-size: 16px; margin: 12px 0; border-radius: 6px; border: 1px solid #ccc; width: 80%; max-width: 400px; }
    .btn { background-color: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 6px; font-size: 16px; cursor: pointer; margin: 15px 0; text-decoration: none; display: inline-block; }
    .btn:disabled { background-color: #cccccc; cursor: not-allowed; }
    #output { margin-top: 25px; }
    #output input { direction: ltr; font-family: monospace; width: 90%; max-width: 600px; padding: 10px; font-size: 14px; border: 1px solid #ccc; border-radius: 6px; }
    #preview-img { margin-top: 10px; max-width: 200px; border-radius: 8px; border: 2px solid #ccc; display: none; }
    .loader { border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; display: none; margin: 20px auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>


  <h2>🇮🇷 لینک‌ساز پویش پرچم بالا</h2>
  <p>ابتدا تصویر خود را انتخاب کنید و سپس قاب دلخواه را برگزینید:</p>
  <p class="warning">⚠️ توجه: برای ساخت لینک، تصویر شما به صورت موقت در یک سرویس آپلودسنتر آپلود می‌شود.</p>

  <input type="file" id="image-upload" accept="image/*"><br>
  <img id="preview-img" alt="پیش‌نمایش تصویر شما"><br>

  <select id="frame-select">
    <option value="frame1">🖼 قاب شماره ۱</option>
    <option value="frame2">🖼 قاب شماره ۲</option>
    <option value="frame3">🖼 قاب شماره ۳</option>
  </select><br>

  <button class="btn" id="generate-btn" onclick="processRequest()" disabled>🔗 ساخت لینک تصویر نهایی</button>

  <div id="output">
    <div class="loader" id="loader"></div>
    <div id="result-container"></div>
  </div>

  <script>
    // --- تنظیمات اصلی ---
    const IMGBB_API_KEY = "YOUR_API_KEY_HERE"; // <--- کلید API خود را اینجا قرار دهید
    const IMGIX_DOMAIN = "bale-bot.imgix.net";
    const FRAME_IMAGE_URLS = {
      frame1: "https://i.postimg.cc/C1BBK6h4/Parcham-Frame-1.png",
      frame2: "https://i.postimg.cc/SKsK0zCn/Parcham-Frame-2.png",
      frame3: "https://i.postimg.cc/bN4wwSGb/Parcham-Frame-3.png"
    };
    // -------------------

    let userImageFile = null;
    const uploadInput = document.getElementById('image-upload');
    const generateBtn = document.getElementById('generate-btn');
    const loader = document.getElementById('loader');
    const resultContainer = document.getElementById('result-container');

    uploadInput.addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (!file) {
        userImageFile = null;
        generateBtn.disabled = true;
        document.getElementById('preview-img').style.display = 'none';
        return;
      }
      userImageFile = file;
      document.getElementById('preview-img').src = URL.createObjectURL(file);
      document.getElementById('preview-img').style.display = 'inline-block';
      generateBtn.disabled = false;
    });

    /**
     * این تابع، نسخه مرورگر و قابل اجرای منطقی است که شما می‌خواستید.
     * @param {string} userImageUrl - لینک عمومی تصویر آپلود شده کاربر
     * @param {string} frameKey - کلید قاب انتخاب شده
     */
    function createFinalImageUrlWithImgix(userImageUrl, frameKey) {
      const frameUrl = FRAME_IMAGE_URLS[frameKey];
      
      // پارامترهای اصلی برای تصویر کاربر
      const baseImageParams = new URLSearchParams({
        'w': '512', 'h': '512', 'fit': 'crop', 'crop': 'faces,entropy'
      });

      // پارامترهای قاب که به عنوان واترمارک اعمال می‌شود
      const encodedFrameUrl = btoa(frameUrl).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
      const overlayParams = new URLSearchParams({
        'mark64': encodedFrameUrl, 'mark-w': '512', 'mark-h': '512', 'mark-fit': 'crop'
      });

      // ترکیب همه پارامترها
      const finalParams = `${baseImageParams.toString()}&${overlayParams.toString()}`;
      
      // ساخت لینک نهایی. Imgix تصویر را از لینک عمومی کاربر می‌خواند.
      // ما فرض می‌کنیم سورس bale-bot.imgix.net به عنوان پراکسی وب تنظیم شده است.
      return `https://${IMGIX_DOMAIN}/${userImageUrl}?${finalParams}`;
    }

    async function processRequest() {
      if (!userImageFile) {
        alert("لطفاً ابتدا تصویری را انتخاب نمایید.");
        return;
      }
      if (IMGBB_API_KEY === "YOUR_API_KEY_HERE") {
          alert("خطای تنظیمات: لطفاً ابتدا کلید API خود را از سایت imgbb.com دریافت کرده و در کد قرار دهید.");
          return;
      }

      loader.style.display = 'block';
      generateBtn.disabled = true;
      resultContainer.innerHTML = '';

      // مرحله ۱: آپلود تصویر کاربر به imgbb برای دریافت یک لینک عمومی
      const formData = new FormData();
      formData.append('image', userImageFile);
      
      try {
        const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
          method: 'POST',
          body: formData,
        });
        const result = await response.json();

        if (!result.success) {
          throw new Error(result.error.message || "خطا در آپلود تصویر.");
        }

        const uploadedUserImageUrl = result.data.url;

        // مرحله ۲: ساخت لینک نهایی Imgix با استفاده از تابعی که می‌خواستید
        const frameKey = document.getElementById("frame-select").value;
        const finalUrl = createFinalImageUrlWithImgix(uploadedUserImageUrl, frameKey);

        // مرحله ۳: نمایش نتیجه به کاربر
        resultContainer.innerHTML = `
          <p>✅ لینک تصویر نهایی با موفقیت ساخته شد:</p>
          <input type="text" value="${finalUrl}" readonly onclick="this.select()">
          <br><br>
          <a href="${finalUrl}" target="_blank" class="btn">مشاهده و ذخیره تصویر</a>
        `;

      } catch (error) {
        console.error("خطا:", error);
        alert(`متاسفانه مشکلی پیش آمد: ${error.message}`);
        resultContainer.innerHTML = `<p style="color:red;">ساخت لینک با خطا مواجه شد. لطفاً از اتصال اینترنت خود مطمئن شوید و دوباره تلاش کنید.</p>`;
      } finally {
        loader.style.display = 'none';
        generateBtn.disabled = false;
      }
    }
  </script>

</body>
</html>
